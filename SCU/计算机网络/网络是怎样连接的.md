![[Pasted image 20240409094011.png |700]]
### 第1章 浏览器生成消息 ——探索浏览器内部
#### 1.1 生成HTTP请求消息
###### 探索之旅从输入网址开始
URL: Uniform Resource Locator
FTP: File Transfer Protocol
HTTP: Hypertext Transfer Protocol

http:   Web服务器
ftp:     FTP服务器

浏览器：有多种客户端功能的综合性客户端软件，通过不同的URL来判断用什么功能来访问数据
![[Pasted image 20240409095207.png|400]]

URL开发的部分的文字表示浏览器应当使用的访问方法

###### 浏览器先要解析URL
拆分元素
e.g. http: + // + web服务器名 + / + 目录名 + / ...... + 文件名

###### 省略文件名的情况
e.g. http://ww.lab/glasscom.com/dir/

以“/”结尾代表省略后面的文件
访问事先设置好的默认文件，大多数情况下是index.html或default.htm

没有路径名时，访问根目录下的默认文件

存在文件，作为文件名处理
存在目录，作为目录名处理

###### HTTP的基本思路
![[Pasted image 20240806110306.png|400]]
HTTP协议定义了客户端和服务器之间交互的**消息内容**和**步骤**
消息
	“对什么”：URI（Uniform Resource Identifier），其内容是一个存放网页数据的文件名或者是一个CGI程序（按照CGI规范来工作的程序就称为CGI程序），就是访问目标
	“进行怎样的操作”：方法
	用来表示附加信息的头字段：可有可无
	![[Pasted image 20240409104251.png|400]]
Web服务器对消息内容进行解析，通过URI和方法完成工作，结构存放在响应信息中
	响应消息开头有一个状态码，表示操作的执行结果成功与否，“404 Not Found"就是状态码
响应消息会被发送回客户端，被接收后，浏览器会从消息中读出所需的数据并显示

GET方法：获取网页数据
POST方法：在表单中填写数据并将其发送给web服务器

###### 生成HTTP请求消息
![[Pasted image 20240806110609.png|400]]

###### 发送请求后会收到响应
状态码（数字）和响应短语


#### 1.2 向DNS服务器查询Web服务器的IP地址
###### IP地址的基本知识
网络号 “号”
主机号 “室”

32比特的数字，8比特一组分为4组
![[Pasted image 20240807101330.png|400]]

![[Pasted image 20240807101619.png|400]]

###### 域名和IP地址并用的理由
域名：方便记忆
IP地址：32比特 负担小

###### Socket库提供查询IP地址的功能
DNS解析器
Socket库是用于调用网络功能的程序组件集合

###### 通过解析器向DNS服务器发出查询
**解析器**向DNA服务器发送查询消息，然后DNS服务器会返回响应消息

###### 解析器的内部原理
![[Pasted image 20240807103935.png|400]]


#### 1.3 全世界DNS服务器的大接力
###### DNS服务器的基本工作
接收来自客服端的查询消息，然后根据消息的内容返回响应
![[Pasted image 20240807104629.png|400]]

###### 域名的层次结构
DNS服务器中的所有信息都是按照域名以分层次的结构来保存的

在域名中，越靠右的位置表示其层级越高

###### 寻找相应的DNS服务器并获取IP地址
根域
![[Pasted image 20240807110249.png|400]]

###### 通过缓存加快DNS服务器的响应


#### 1.4委托协议栈发送消息
###### 数据收发操作概览
套接字：数据管道出入口
收发数据：
1. 创建套接字
2. 将管道连接到服务器端的套接字上
3. 收发数据
4. 断开管道并删除套接字

###### 创建套接字阶段
调用Socket库中的socket程序组件
应用程序通过描述符识别套接字

###### 连接阶段：把管道接上去
调用Socket库中的connect程序组件
三个参数：描述符、服务器IP地址和端口号
	描述符：应用程序用来识别套接字的机制
	IP地址和端口号：客户端和服务器之间用来识别对方套接字的机制

指定了事先规定好的端口号，就可以连接到相应的服务器程序的套接字

###### 通信阶段：传递消息
将数据送入套接字：调用write程序组件
接收消息：调用read程序组件

###### 断开阶段：收发数据结束
调用close程序组件


### 第2章 用电信号传输TCP/IP数据 ——探索协议栈和网卡
#### 2.1 创建套接字
###### 协议栈的内部结构
![[Pasted image 20240808084525.png|400]]
浏览器、邮件等一般应用程序收发数据时用TCP
DNS查询等收发较短的控制数据时用UDP

###### 套接字的实体就是通信控制信息
套接字：协议栈内部的一块用于存放控制信息的内存空间
协议栈是根据套接字中的记录的控制信息来工作的
![[Pasted image 20240808085745.png|400]]
###### 调用socket时的操作
创建套接字
	分配空间，写入表示初始状态的控制信息
将描述符告知应用程序
	描述符用于区分协议栈中的多个套接字
应用程序收发数据时提供描述符

#### 2.2 连接服务器
###### 连接是什么意思
连接实际上是通信双方交换控制信息
根据通信规则执行连接操作，得到必要的信息从而完成数据收发的准备，并分配缓冲区

###### 负责保存控制信息的头部
控制信息：
1. 客户端和服务器相互联络时交换的控制信息，添加在网络包的开头，称为TCP头部![[Pasted image 20240808092711.png|400]]
2. 保存在套接字中用来控制协议栈操作的信息

![[Pasted image 20240808092957.png|400]]

###### 连接操作的实际过程
1. 在TCP模块处创建表示连接控制信息的头部（通过TCP头部中的发送方和**接收方端口号**可以找到要连接的套接字）
2. TCP模块将信息传递给IP模块并委托它进行发送
3. 网络包到达服务器后，服务器的IP模块会将收到的数据传递给TCP模块
4. 服务器的TCP模块根据TCP头部的信息找到对应的套接字，写入相应信息，状态改为正在连接
5. 操作完成后，返回响应（将ACK控制位设为1，表示已接收网络包），在TCP头部设置发送方和接收方端口号以及SYN比特
6. 客户端接收网络包，通过TCP头部信息确认是否连接成功（SYN为1则成功）
7. 客户端将ACK比特设置为1并发挥服务器

#### 2.3 收发数据
###### 将HTTP请求消息交给协议栈
协议栈收到数据执行发送操作
- 不关心内容
- 不立马发送，先存放在发送缓冲区
	- 网络包能容纳的数据长度MTU（网络包最大长度） MSS（除去头部）
	- 等待时间
![[Pasted image 20240808095421.png|400]]

###### 对较大的数据进行拆分
缓冲区中数据超过MSS长度，不需要等待
数据以MSS长度为单位进行拆分，每块数据被放进单独的网络包中，添加TCP头部

###### 使用ACK号确认网络包已收到
**TCP**具备确认对方是否收到网络包，以及当没收到时进行重发的功能
![[Pasted image 20240809093405.png|400]]

在开始收发数据之前将初始值告知通信对象
在连接阶段，设置SYN时同时设置序号字段的值（即初始值）

双向传递消息
![[Pasted image 20240809094206.png|400]]

###### 根据网络包平均往返时间调整ACK号等待时间
TCP采用动态调整等待时间的办法

###### 使用窗口有效管理ACK号
滑动窗口
能够接收的最大数据量称为窗口大小
![[Pasted image 20240809095303.png|400]]

###### ACK与窗口的合并
接收数据后，发送ACK号和窗口更新
等待一段时间，合并通知

###### 接收HTTP响应消息
浏览器发送HTTP请求消息后，等待Web服务器返回响应消息


#### 2.4 从服务器断开并删除套接字
###### 数据发送完毕后断开连接
![[Pasted image 20240809102653.png|400]]

###### 删除套接字
不立即删除，防止误操作
等待时间与包重传的操作方式有关

###### 数据收发操作小结
![[Pasted image 20240809103307.png|400]]

#### 2.5 IP与以太网的包收发操作 ⭐
###### 包的基本知识
包=头部（控制信息）+数据（将发送的数据）

发送方和接收方统称为终端节点

网络中有路由器和集线器两种不同的转发设备
	路由器按照IP规则传输包，根据目标地址判断下一个IP转发设备的位置
	集线器按照以太网规则传输包，将包传输到下一个转发设备
![[Pasted image 20240810090145.png|400]]
###### 包收发操作概览
IP模块仅仅是整个包传输过程的入口
传输到接收方的工作是由集线器、路由器等网络设备来完成的

1. TCP模块委托IP模块发送包（在数据库前面加上TCP模块），指定通信对象的IP地址
2. IP模块会将包的内容当作一整块数据，在前面加上包含控制信息的头部，包括IP头部、MAC头部
3. 封装好的包（01）会被交给网络硬件（网卡），网卡将数字信息转换为电信号或光信号，通过网线（光纤）发送出去
4. 包送达对方后，对方会作出响应，接收过程与发送过程相反
![[Pasted image 20240810091308.png|400]]

###### 生成包含接收方IP地址的IP头部
![[Pasted image 20240810091557.png|400]]
接收方IP地址：通信对象的IP地址
发送方IP地址：需要判断发送所使用的网卡，并填写该网卡的IP地址
协议号：表示包的内容来自哪个模块

###### 生成以太网用的MAC头部
![[Pasted image 20240810093043.png|400]]
发送方MAC地址：网卡本身的MAC地址，网卡生产时写入ROM
接收方MAC地址：从路由表中找到IP地址，根据IP地址查询MAC地址

###### 通过ARP查询目标路由器的MAC地址
ARP，广播，可以把包发送给连接在用一以太网中的所有设备
查询结果放到ARP缓存的内存空间，ARP缓存中的值过一段时间后会被删除

###### 以太网的基本知识
以太网是一种为多台计算机能够彼此自由和廉价地相互通信而设计的通信技术

黑房间里讲话——信号开头加上接受者的信息（地址）
![[Pasted image 20240810100559.png|400]]
三个性质：
发送到MAC头部的接收方MAC地址代表的目的地
用发送方MAC地址识别发送方
用以太网类型识别包的内容

###### 将IP包转换成电或光信号发送出去
![[Pasted image 20240810100927.png|400]]
计算机启动操作系统时，网卡驱动程序会对硬件进行初始化操作

ROM中保存着全世界唯一的MAC地址
网卡中保存的MAC地址会由网卡驱动程序读取并分配给MAC模块

###### 给网络包再加3个控制数据
![[Pasted image 20240810101455.png|400]]
![[Pasted image 20240810102408.png|400]]

报头：56比特，确定包的读取时机（先判断时钟信号的变化周期
FCS（帧校验序列）：32比特，公式计算得出，检查包传输过程中因噪声导致的波形紊乱、数据错误

###### 向集线器发送网络包
发送信号的操作分为两种，一种是使用集线器的半双工模式，另一种是使用交换机的全双工模式

半双工模式为了避免信号碰撞，要先判断网线中是否存在其他设备发送的信号

网卡的MAC模块生成通用信号，然后由PHY（MAU）模块转换成可在网线中传输的格式，并通过网线发送出去

###### 接收返回包
与发送相反
PHY(MAU)模块先开始工作，然后再轮到MAC模块

过程：
转数字信息，放缓冲区
检查FCS
判断是不是发给自己的（半双工模式，发送的信号会到达连接在集线器上的所有设备）
是则放入缓冲区
中断程序调用网卡驱动，取出收到的包，判断协议类型

###### 将服务器的响应包从IP传递给TCP
IP模块：检查IP头部，查看接收方IP地址（错误会通过ICMP消息告知发送方），分片重组
TCP模块：根据IP头部的接收方和发送方UP地址，以及TCP头部中的接收方和发送方端口号来查找对应的套接字


#### 2.6 UDP协议收发操作
###### 不需要重发的数据用UDP发送更高效
向DNS服务器查询IP地址的时候我们用的是UDP协议

数据短，就一个包，就不需要TCP
###### 控制用的短数据
UDP没有TCP的接收确认、窗口等机制，不需要建立和断开连接的步骤

UDP只负责单纯地发送包
![[Pasted image 20240811091758.png|400]]

###### 音频和视频数据
发送音频和视频数据也使用UDP（必须在规定时机内送达）


### 第3章 从网线到网络设备 ——探索集线器、交换机和路由器
#### 3.1 信号在网线和集线器中传输
###### 每个包都是独立传输的
无论包里面装的是应用程序的数据或者是TCP协议的控制信息，都不会对包的传输操作本身产生影响
![[Pasted image 20240811094301.png|400]]

###### 防止网线中的信号衰减很重要
网卡中的PHY(MAU)模块将包转换成电信号，信号通过RJ-45接口进入双绞线

网线越长，信号衰减越严重

###### “双绞”是为了抑制噪声
双绞就是以两根信号线为一组缠绕在一起，为了抑制噪声的影响

产生噪声的原因：网线周围有电磁波，当电磁波接触到金属等导体时，在其中就会产生电流
影响网线的电磁波分两种：
- 由电机、荧光灯、CRT显示器等设备泄露出来的电磁波
- 从网线中相邻的信号线泄露出来的

###### 集线器将信号发往所有线路
集线器将信号发送给所有连接在它上面的路线

MDI就是对RJ-45接口和信号收发模块进行直接接线，MDI-X则是交叉接线
![[Pasted image 20240811095940.png|400]]

#### 3.2 交换机的包转发操作
###### 交换机根据地址表进行转发
交换机将网络包原样转发到目的地
![[Pasted image 20240811101554.png|400]]
交换机的端口不核对接收方MAC地址，而是直接接收所有的包并存放到缓冲区，因此，交换机的端口不具有MAC地址

###### MAC地址表的维护
收到包时，将发送MAC地址以及其输入端口的号码写入MAC地址表
删除地址表中某条记录的操作，防止设备移动时产生问题

###### 特殊操作
交换机查询地址表之后发现记录中的目标端口和这个包的源端口是同一个端口
	当交换机发现一个包要发回源端口时，直接丢弃这个包

地址表中找不到指定的MAC地址
	将包转发到除了源端口之外的所有端口

###### 全双工模式可以同时进行发送和接收
全双工模式是交换机特有的工作模式，它**可以同时进行发送和接收操作**（不需要考虑信号碰撞），集线器不具备这样的特性

###### 自动协商：确定最优的传输速率
自动协商：自动切换工作模式、探测对方的传输速率并进行自动切换
![[Pasted image 20240811104007.png|400]]

###### 交换机可同时执行多个转发操作
多个端口可同时传输包
集线器则不能

#### 3.3 路由器的包转发操作
###### 路由器的基本知识
路由器是基于IP设计的，而交换机是基于以太网设计的

路由器包括转发模块（判断包的转发目的地）和端口模块（包的收发操作）
![[Pasted image 20240812093623.png|400]]

端口模块是以实际的发送方或者接收方的身份来收发网络包的，端口具有IP地址和MAC地址

###### 路由表中的信息
路由器根据“IP地址”判断转发目标
![[Pasted image 20240812094401.png|400]]

最左侧的目标地址列记录的是接收方的信息，只包含表示子网的网络号部分的比特值，主机号的全部为0

路由器会忽略主机号，只匹配网络号

路由聚合：将几个子网合并成一个子网，在路由表中只产生一条记录
![[Pasted image 20240812095207.png|400]]

路由表的子网掩码列只表示在匹配网络包目标地址时需要对比的比特数量

路由器中对路由表的维护是与包转发操作相互独立的

维护方法分为两类：
1. 由人手动维护
2. 根据路由协议机制，通过路由器之间的信息交换由路由器自行维护路由表的记录

###### 路由器的包接收操作
路由器的端口（以太网端口）与计算机的网卡基本相同

路由器的端口都具有MAC地址，只接收与自身地址匹配的包，遇到不匹配的包则直接丢弃

###### 查询路由表确定输出端口
通过路由器转发的网络包，其接收方MAC地址为路由器端口的MAC地址
接收后，丢弃包开头的MAC头部

判断转发目标：
1. 根据IP地址查询路由表中的目标地址栏
2. 路由器寻找比特数最长的一条记录（最长匹配原则）
3. 记录长度相同，再根据跃点计数的值进行判断
4. 没找到匹配的记录，丢弃这个包，通过ICMP消息告知发送方

###### 找不到匹配路由时选择默认路由
路由表中子网掩码为0.0.0.0的记录表示“默认路由”

###### 包的有效期
找到转发目标后，在发送之前，更新IP头部中的TTL(Time to Live)字段，防止包陷入死循环

###### 通过分片功能拆分大网络包
输出端口的最大包长度可能小于输入端口

使用IP协议中定义的分片功能对包进行拆分，缩短每个包的长度

![[Pasted image 20240812102939.png|400]]
知道输出端口的MTU，看能不能不分片直接发送
看IP头部中的标志字段，确认是否可以分片
TCP头部及其后面的部分都是可分片的数据

###### 路由器的发送操作和计算机相同
路由器判断下一个转发目标的方法：
- 如果路由表的网关列内容为 IP 地址，则该地址就是下一个转发目标。
- 如果路由表的网关列内容为空，则 IP 头部中的接收方 IP 地址就是下一个转发目标。

路由器也会使用ARP来查询下一个转发目标的MAC地址

###### 路由器与交换机的关系
IP（路由器）负责将包发送给通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网（交换机）来负责的

#### 3.4 路由器的附加功能
###### 通过地址转换有效利用IP地址
规定某些地址是用于内网的，这些地址叫作私有地址，而原来的固定地址则叫作公有地址

内网中可用作私有地址的范围仅限以下这些：
10.0.0.0 ～ 10.255.255.255 
172.16.0.0 ～ 172.31.255.255 
192.168.0.0 ～ 192.168.255.255

内网中的设备不能和互联网直接收发网络包，而是
通过一种特别的机制进行连接，这个机制就叫**地址转换**
![[Pasted image 20240812104740.png|400]]

###### 地址转换的基本原理
地址转换的基本原理是在转发网络包时对 IP 头部中的 IP 地址和端口号 A 进行改写
![[Pasted image 20240812104930.png|400]]


###### 改写端口号的原因
如果用公有地址加上端口的组合对应一个私有地址，一个公有地址就可以对应几万个私有地址，这种方法提高了公有地址的利用率。

###### 从互联网访问公司内网
对于从互联网访问公司内网的包，如果在对应表中没有记录就无法正常转发

除非公司主动允许，否则是无法从互联网向公司内网发送网络包的，这种机制具有防止非法入侵的效果

用于外网访问的服务器可以放在地址转换设备的外面并为它**分配一个公有地址**，也可以**将服务器的私有地址手动添加到地址转换设备中**，这样就可以从互联网访问到这台具有私有地址的服务器了

###### 路由器的包过滤功能
在对包进行转发时，根据 MAC 头部、IP 头部、TCP 头部的内容 A，按照事先设置好的规则决定是转发这个包，还是丢弃这个包


### 第4章 通过接入网进入互联网内部 ——探索接入网和网络运营商
#### 4.1 ADSL接入网的结构和工作方式
###### 互联网的基本结构和家庭、公司网络是相同的
![[Pasted image 20240813091958.png|400]]
不同：距离和维护方法

###### 连接用户与互联网的接入网
互联网接入路由器是按照接入网规则来发送包的

所谓接入网，就是指连接互联网与家庭、公司网络的通信线路 ，一般家用的接入网方式包括ADSL, FTTH, CATV, 电话线, ISDN

###### ADSL Modem将包拆分成信元
![[Pasted image 20240813092706.png|600]]
互联网接入路由器会在网络包前面加上 MAC 头部、PPPoE 头部、PPP 头 部 总 共 3 种 头 部， 然 后 发 送 给 ADSL Modem（PPPoE 方式下）

包就到达了 ADSL Modem，然后，ADSL Modem 会把包拆分成很多小格子，每个小格子称为一个信元，信元是一个非常小的数据块，开头是有 5 个字节的头部，后面是 48 个字节的数据，用于一种叫作 ATMA 的通信技术（更小一号的包）

**ADSL Modem**将包拆分成信元，并转换成电信号发送给分离器

![[Pasted image 20240813101146.png|400]]

###### ADSL将信元“调制”成信号
ADSL Modem 采用了一种用圆滑波形（正弦波）对信号进行合成来表示 0 和 1 的技术，这种技术称为调制

ADSL采用的调制方式是振幅调制（ASK）和相位调制（PSK）相结合的正交振幅调制（QAM）A 方式
![[Pasted image 20240813094051.png|400]]
![[Pasted image 20240813094235.png|400]]

###### ADSL通过使用多个波来提高速率
![[Pasted image 20240813094747.png|400]]
ADSL 技术中，上行方向（用户到互联网）和下行方向（互联网到用
户）的传输速率是不同的

？？？？
当 Modem 通电后，会发送测试信号，并根据信号的接收情况判断使用的频段数量和每个频段的比特数，这个过程称为训练（握手），需要几秒到几十秒的时间

###### 分离器的作用
分离器的作用其实在相反的方向，也就是信号从电话线传入的时候，
这时，分离器需要负责将电话和 ADSL 的信号进行分离

分离器的功能是将一定频率以上的信号过滤掉，也就是过滤掉了 ADSL 使用的高频信号，这样一来，只有电话信号才会传入电话机，但对于另一头的 ADSL Modem，则是传输原本的混合信号给它

###### 从用户到电话局
信号从这里出来之后，会通过室内电话线，然后到达大楼的 IDFA 和 MDFB，外面的电话线在这里和大楼内部的室内电话线相连接

通过配线盘之后，信号会到达保安器（防止雷电等情况下电话线中产生过大电流）

接下来，信号会进入电线杆上架设的电话电缆

电话局附近的地下电缆很多，线程一条地道，称为电缆隧道，通过电缆隧道进入电话局后，电缆会逐根连接到电话局的MDF上

###### 噪声的干扰
电话线也会受到来自外部的噪声和来自内部的噪声（串扰 A）的干扰，导致信号失真

ADSL 信号受到干扰后并不会立即造成错误，ADSL 信号分布在多个频段上，只有和噪声频率相同的信号会受到影响而无法读取，即可用的信号数量减少，结果导致速率下降

电话线架设在噪声比较多的地方时，可能会导致速率下降
电缆内部产生的噪声也会形成干扰

###### 通过DSLAM到达BAS
信号通过电话线到达电话局之后，会经过配线盘、分离器到达 DSLAM，在这里，电信号会被还原成数字信息——信元

DSLAM一般不用以太网接口，而是用 ATM 接口，和后方路由器收发数据时使用的是原始网络包拆分后的 ATM 信元形式

信元从 DSLAM 出来之后，会到达一个叫作 BAS 的包转发设备
BAS和DSLAM一样，都具有ATM接口

**BAS**负责将ATM信元还原成网络包并转发到互联网内部

#### 4.2 光纤接入网（FTTH）
###### 光纤的基本知识
FTTH，是一种基于光纤的接入网技术
![[Pasted image 20240813105407.png|400]]

光源就会根据信号电压的变化发光，高电压发光亮，低电压发光暗
接收端有可以感应光线的光敏元件，光敏元件可以根据光的亮度产生不同的电压

###### 单模与多模
如果两条光线的相位不一致，就会彼此发生干涉抵消，只有那些相位一致的光线才会继续在光纤中传导

根据纤芯的直径大小，光纤可分成单模光纤和多模光纤

单模光纤：只允许相位一致的最小角度的光进入，对光敏元件和光源要求高，信号失真小，用于距离较远的建筑物之间的连接
多模光纤：可以有多条光线在纤芯中同时传导，对光敏元件和光源要求低，但是光纤越长，失真越大，用于一座建筑物里面的连接

###### 通过光纤分路来降低成本
用光纤来代替 ADSL 将用户端接入路由器和运营商的 BAS 连接起来的接入方式就是 FTTH
- 直连：用一根光纤直接从用户端连接到最近的电话局
	在一条光纤中使用不同的波长传输多个光信号的方式叫作波分复用
- 分路：在用户附近的电线杆上安装一个分光器，通过该设备让光纤分路，同时连接多个用户
![[Pasted image 20240813111006.png|500]]
OLT和ONU中具有通过调整信号收发时机来避免碰撞的功能

两种方式只是光信号的传输方式有些区别，实际传输的网络包是相同的

#### 4.3 接入网中使用的PPP和隧道
###### 用户认证和配置下发
随着接入网发展到 ADSL 和 FTTH，接入网连接的路由器也跟着演进，而这种进化型的路由器就叫 **BAS** （Broadband Access Server）

ADSL和FTTH接入网中，都需要先输入用户名和密码登录，而BAS就是登录操作的窗口，BAS使用PPPoE方式（由传统电话拨号上网上使用的PPP协议发展而来）来实现这个功能

PPP工作过程：
1. 用户向运营商接入点拨打电话
2. 接通后输入用户名和密码登录（通过RADIUS协议从RAS发送到认证服务器）
3. 确认后认证服务器返回IP地址等配置信息，发给用户
4. 用户计算机根据信息配置IP地址等参数，完成TCP/IP收发网络包的准备工作
5. 可以发送TCP/IP包
![[Pasted image 20240814100058.png|400]]
###### 在以太网上传输PPP消息
拨号上网的PPP无法直接用于ADSL和FTTH

要传输 PPP 消息，必须有另一个包含报头、FCS、信号格式等元素的“容器”，然后将 PPP 消息装在这个容器里才行

在拨号接入中PPP借用了HDLC协议（为在专线中传输网络包而设计，在ADSL和FTTH并不能使用）作为容器
![[Pasted image 20240814100806.png|600]]

PPPoE 是将 PPP 消息装入以太网包进行传输的方式

###### 通过隧道将网络包发送给运营商
BAS 除了作为用户认证的窗口之外，还可以使用隧道方式（类似套接字）来传输网络包

隧道实现方式：
1. TCP连接
2. 封装
![[Pasted image 20240814101423.png|400]]

###### 接入网的整体工作过程
整体工作过程：
1. 用户端的互联网接入路由器进行连接操作（通过PPPoE的发现机制查询BAS的MAC地址
2. 进行用户认证（用户名和密码发送给BAS，加密发送、不加密发送）和下发配置（如何下发配置信息）
3. 客户端开始发送用来访问互联网的网络包（按照PPPoE规则转发）![[Pasted image 20240814104133.png|400]]
4. 网络包会到达 BAS，而 BAS 会将 MAC 头部和 PPPoE 头部去掉，取出 PPP 头部以及后面的部分，然后通过隧道机制将包发送出去
5. PPP包会沿隧道到达另一端的出口，也就是网络运营商的路由器

###### 不分配IP地址的无编码端口
一对一连接的端口可以不分配 IP 地址，这种方式称为无编号

###### 互联网接入路由器将私有地址转换成公有地址
如果将这些信息配置在计算机上，就相当于计算机拥有了公有地址，这种情况下不需要进行地址转换也可以访问互联网

######  除PPPoE之外的其他方式
- 使用PPPoA方式的ADSL接入网
	不添加MAC头部和PPPoE头部，而是直接将包装入信元中
	计算机、路由器和ADSL Modem必须是一体的（USB连接、整合成一台设备）
	比PPPoE效率高（MTU大）
- 使用DHCP协议向用户端下发TCP/IP配置信息
	DHCP 经常用于通过公司网络向客户端计算机下发 TCP/IP 配置信息
	不需要添加PPP头部，将以太网包直接转换成ADSL信号发送给DSLAM

#### 4.4 网络运营商的内部
###### POP和NOC
ADSL、FTTH 等接入网是与用户签约的运营商设备相连的，这些设备称为 POP，互联网的入口就位于这里
![[Pasted image 20240817090437.png|400]]

根据接入网类型使用不同路由器
![[Pasted image 20240817090731.png|400]]

NOC是运营商的核心设备，从 POP 传来的网络包都会集中到这里，并从这里被转发到离目的地更近的 POP，或者是转发到其他的运营商（规模扩大后的POP）

###### 室外通信线路的连接
对于自己拥有光纤的运营商来说，可以选择最简单的方式，也就是用光纤将 NOC 和 POP 直接连接起来

拥有光纤的公司一般都会提供光纤租用服务
不拥有光纤的运营商则可以使用租借通信线路的方式将相距较远的NOC 和 POP 连接起来

#### 4.5 跨境运营商的网络包
###### 运营商之间的连接
路由器根据路由表中的信息判断转发目标，这个转发目标可能是 NOC，也可能是相邻的POP
经过几次转发之后，网络包就到达了Web服务器所在的POP的路由器，从这里被继续转发到Web服务器

###### 运营商之间的路由信息交换
![[Pasted image 20240817091935.png|400]]
路由信息交换的过程是由路由器自动完成的，这里使用的机制称为 BGP（Border Gateway Protocol）
![[Pasted image 20240817092236.png|400]]

###### 与公司网络中自动更新路由表机制的区别
公司中使用的方式是寻找与目的地之间的最短路由，并按照最短路由来转发包，因此，周围的所有路由器都是平等对待的

采用最短路由的缺点：
所有运营商都走最短线路，无法区分是否缴费

路由交换机制：
指定路由交换的对象
设置优先级

###### IX的必要性
IX（Internet eXchange）
![[Pasted image 20240817093014.png|400]]

###### 运营商如何通过IX互相连接
- 部署场所：抗震
- 核心：具有大量高速以太网端口的二层交换机
- 将各个运营商的路由器连接到IX核心交换机上
	从NOC中将光纤延长出来接到IX交换机
	用通信线路将路由器和交换机连起来
![[Pasted image 20240817093523.png|400]]

### 第5章 服务器端的局域网中有什么玄机
#### 5.1 Web服务器的部署地点
###### 在公司里部署Web服务器
网络包通过最近的POP中的路由器、接入网以及服务器端路由器之后，直接到达了服务器（可以从互联网直接访问）

缺点：
	IP地址不足
	安全问题

![[Pasted image 20240819100828.png|400]]
###### 将Web服务器部署在数据中心
数据中心是与运营商核心部分NOC直接连接的，或者是与运营商之间的枢纽IX直接连接的，可以获得很高的访问速度

无论如何，网络包通过路由器的层层转发，最终到达服务器的这个过程都是相同的
#### 5.2 防火墙的结构和原理
###### 主流的包过滤方式
防火墙只允许发往特定服务器中的特定应用程序的包通过，然后屏蔽其他的包

方式包括：包过滤、应用层网关、电路层网关等

###### 如何设置包过滤的规则
网络包的头部包含了用于控制通信操作的控制信息
![[Pasted image 20240819102025.png|400]]

###### 通过端口号限定应用程序
当我们要限定某个应用程序时，可以在判断条件中加上 TCP 头部或者UDP 头部中的**端口号**

###### 通过控制位判断连接方向
根据访问的方向来进行判断，用到TCP头部中的控制位（SYN、ACK）

###### 从公司内网访问公开区域的规则
要设置互联网和公开区域之间的包过滤规则，还需要设置公司内网和互联网之间，或者公司内网与公开区域之间的包过滤规则（注意不要让这些规则**相互干扰**）

###### 从外部无法访问公司内网
包过滤方式的防火墙不仅可以允许或者阻止网络包的通过，还具备地址转换功能

###### 通过防火墙
阻止：包被丢弃并被记录下来
通过：转发出去，过程和路由器相同

包过滤方式的防火墙可根据接收方 IP 地址、发送方 IP 地址、接收方端口号、发送方端口号、控制位等信息来判断是否允许某个包通过

###### 防火墙无法抵御的攻击
即便包中含有特定数据，防火墙也无法发现，于是包就被放行了，然后，当包到达 Web 服务器时，就会引发服务器宕机

方法：
	修复Bug防止宕机
	在防火墙之外部署用来检查包的内容并阻止有害包的设备或软件


#### 5.3 通过将请求平均分配给多台服务器来平衡负载
###### 性能不足时需要负载均衡
使用多台服务器来分担负载，这种架构统称为**分布式架构**

通过DNS服务器来分配
通过**轮询**的方式将访问平均分配给所有的服务器
![[Pasted image 20240819104939.png|400]]

在通过 CGI 等方式动态生成网页的情况下，有些操作是要跨多个页面的，如果这期间访问的服务器发生了变化，这个操作就可能无法继续

###### 使用负载均衡器分配访问
使用**负载均衡器**时，首先要用负载均衡器的 IP 地址代替 Web 服务器的实际地址注册到 DNS 服务器上

客户端会认为负载均衡器是一台Web服务器，发送请求，由负载均衡器来判断将请求转发给哪台Web服务器
![[Pasted image 20240819105001.png|400]]
当操作跨多个页面时（在HTTP头部字段加上判断相关性的信息），则不考虑 Web 服务器的负载，而是必须将请求发送到同一台 Web 服务器上

#### 5.4 使用缓存服务器分担负载
###### 如何使用缓存服务器
缓存服务器是一台通过代理机制对数据进行缓存的服务器。代理介于Web 服务器和客户端之间，具有对 Web 服务器访问进行中转的功能

###### 缓存服务器通过更新时间管理内容
![[Pasted image 20240827100310.png|400]]

###### 最原始的代理——正向代理
缓存服务器使用的代理机制最早就是放在客户端一侧的，这才是代理的原型，称为**正向代理**（forward proxy）


在使用正向代理时，一般需要在浏览器的设置窗口中的“代理服务器” 一栏中填写正向代理的 IP 地址，浏览器发送请求消息的过程也会发生相应的变化
![[Pasted image 20240827100905.png|400]]

###### 正向代理的改良版——反向代理
通过将请求消息中的 URI 中的目录名与 Web 服务器进行关联，使得代理能够转发一般的不包含完整网址的请求消息，这种方式称为**反向代理**（reverse proxy）

###### 透明代理
通过查看请求消息的包头部判断转发目标的方法称为透明代理（transparent proxy）

将透明代理放在请求消息从浏览器传输到 Web 服务器的路径中，当消息经过时进行拦截

#### 5.5 内容分发服务
###### 利用内容分发服务分担负载
Web 服务器运营者和网络运营商签约，将可以自己控制的缓存服务器放在客户端的运营商处

![[Pasted image 20240827102633.png|500]]

为了解决这个问题，一些专门从事相关服务的厂商
出现了，他们来部署缓存服务器，并租借给 Web 服务器运营者，这种服务称为**内容分发服务**，提供这种服务的厂商称为CDSP（content delivery service provider）

###### 如何找到最近的缓存服务器
1. 需要事先从缓存服务器部署地点的路由器收集路由信息
2. DNS 服务器根据路由表查询从本机到 DNS 查询消息的发送方，也就是客户端 DNS 服务器的路由信息
3. 通过比较找出哪一台路由器距离客户端 DNS 服务器最近

###### 通过重定向服务器分配访问目标
将客户端访问引导到另一台Web 服务器的操作称为重定向，通过这种方法也可以将访问目标分配到最近的缓存服务器

缺点：增加了HTTP消息的交互次数，**开销大**
优点：重定向的方法是根据客户端发送来的 HTTP 消息的发送方 IP 地址来估算距离的，因此**精度较高**

###### 缓存的更新方法会影响性能
让 Web 服务器在原始数据发生更新时，立即通知缓存服务器，使得缓存服务器上的数据一直保持最新状态

### 第6章 请求到达web服务器，响应返回浏览器 ——短短几秒的“漫长旅途”迎来终点
#### 6.1 服务器概览
###### 客户端与服务器的区别
硬件和操作系统不同
客户端发起连接操作，服务器等待连接操作
服务器的程序可以同时和多台客户端计算机进行通信

###### 服务器程序的结构
每有一个客户端连接进来，就启动一个新的服务器程序，确保服务器程序和客户端是一对一的状态

服务器操作系统具有多任务、多线程功能，可以同时运行多个程序

###### 服务器端的套接字和端口号
（1）创建套接字（创建套接字阶段）
（2-1）将套接字设置为等待连接状态（等待连接阶段）
（2-2）接受连接（接受连接阶段）
（3）收发数据（收发阶段）
（4）断开管道并删除套接字（断开阶段）

![[Pasted image 20240903200354.png|400]]

新创建的套接字副本必须和原来的等待连接的套接字具有相同的端口号

要确定某个套接字时，不仅使用服务器端套接字对应的端口号，还同时使用客户端的端口号再加上 IP 地址

使用描述符来指代套接字的原因如下：
	（1）等待连接的套接字中没有客户端 IP 地址和端口号（2）使用描述符这一种信息比较简单

#### 6.2 服务器的接收操作
###### 网卡将接收到的信号转换成数字信息
![[Pasted image 20240903201139.png|400]]

网卡的 MAC 模块将网络包从信号还原为数字信息，校验 FCS 并存入缓冲区

网卡驱动会根据 MAC 头部判断协议类型，并将包交给相应的协议栈

###### IP模块的接收操作
1. IP模块首先会检查 IP 头部的格式是否符合规范，然后检查接收方 IP 地址，看包是不是发给自己的
2. 确认包是发给自己的之后，接下来需要检查包有没有被分片，若分片则暂存，等待全部分片到达后组装
3. 检查IP头部的协议号字段，并将包转交给相应的模块

###### TCP模块如何处理连接包
如果收到的是发起连接的包，则 TCP 模块会
（1）确认 TCP 头部的控制位 SYN；
（2）检查接收方端口号；
（3）为相应的等待连接套接字复制一个新的副本；
（4）记录发送方 IP 地址和端口号等信息

![[Pasted image 20240903202233.png|400]]

###### TCP模块如何处理数据包
收到数据包时，TCP 模块会
（1）根据收到的包的发送方 IP 地址、发送方端口号、接收方 IP 地址、接收方端口号找到相对应的套接字；
（2）将数据块拼合起来并保存在接收缓冲区中；
（3）向客户端返回 ACK

###### TCP模块的断开操作
1. 服务器程序会调用 Socket 库的 close，TCP 模块会生成一个控制位 FIN 为 1 的 TCP 头部，并委托 IP 模块发送给客户端
2. 客户端收到后返回一个ACK号，调用close，生成一个FIN为1的TCP头部发给服务器
3. 服务器返回ACK号，断开操作完成，一段时间后套接字被删除

#### 6.3 Web服务器程序解释请求消息并显示内容
###### 将请求的URI转换为实际的文件名
![[Pasted image 20240904205132.png|400]]
请求消息包括一个称为“方法”的命令，以及表示数据源的 URI（文件路径名），服务器程序会根据这些内容向客户端返回数据，但对于不同的方法和 URI，服务器内部的工作过程会有所不同

Web 服务器公开的目录其实并不是磁盘上的实际目录，而是虚拟目录，而 URI 中写的就是在这个虚拟目录结构下的路径名

先查询虚拟目录与实际目录的对应关系，并**将URI 转换成实际的文件名后**，才能读取文件并返回数据

###### 运行CGI程序
若URI指定的文件内容是一个程序，服务器不会直接返回文件内容，而是会运行这个程序，然后将程序输出的数据返回给客户端

过程：
1. Web服务器判断文件是否是程序（根据扩展名或属性）
2. Web服务器委托操作系统运行程序，从请求消息中取出数据（GET/POST）
3. 程序对数据进行处理，将输出的数据返回给Web服务器，嵌入到HTML文档中
4. Web服务器直接将其作为响应消息返回给客户端

###### Web服务器的访问控制
Web 服务器的基本工作方式就是根据请求消息的内容判断数据源，并从中获取数据返回给客户端

Web服务器可以检查事先设置一些规则，并根据规则允许或禁止访问。根据规则判断是否允许访问的功能称为**访问控制**

规则主要有以下三种：
1. 客户端IP地址
2. 客户端域名
3. 用户名和密码

![[Pasted image 20240904210610.png|400]]

![[Pasted image 20240904210714.png|400]]

###### 返回响应消息
1. Web 服务器调用 Socket 库的 write，将响应消息交给协议栈（给出表示通信使用的套接字的描述符）
2. 协议栈将数据拆分，加上头部发送出去
3. 包经过交换机和路由器的转发，通过互联网到达客户端

#### 6.4 浏览器接收响应消息并显示内容
###### 通过响应的数据类型判断其中的内容
首先，网卡将信号还原成数字信息，协议栈将拆分的网络包组装起来并取出响应消息，然后将消息转交给浏览器。

根据响应消息开头的 **Content-Type 头部字段**的值来*判断数据类型*
当数据类型为文本时，还需要判断编码方式，这时需要用charset 附加表示文本编码方式的信息
![[Pasted image 20240904211150.png|400]]

如果消息中存放的内容是通过压缩或编码技术对原始数据进行转换得到的，那么**Content-Encoding** 的值就表示具体的转换方式，通过这个字段的值，我们可以知道如何将消息中经过转换的数据还原成原始数据

###### 浏览器显示网页内容！访问完成！
根据数据类型调用用于显示内容的程序，将数据显示出来


